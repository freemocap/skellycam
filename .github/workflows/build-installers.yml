name: Build installers

on:
  push:
    branches: [ "jon/development", "philip/mac_app" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-13]
        include:
          - os: windows-latest
            venv-activate: .venv\Scripts\activate
            install-port-audio: echo "PortAudio is not needed on Windows"
            build-command: installers\\nuitka_scripts\\nuitka_installer_windows.bat
            server-executable: installers\\nuitka_scripts\\skellycam_server.exe
            electron-output: build\\skellycam_server.exe
          - os: macos-13
            venv-activate: .venv/bin/activate
            install-port-audio: brew install portaudio
            build-command: ./installers/nuitka_scripts/nuitka_installer_mac.sh
            server-executable: /installers/nuitka_scripts/skellycam_server
            electron-output: /build/skellycam_server
    # continue-on-error: true
    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install portaudio
        run: ${{ matrix.install-port-audio }}

      - name: Install Python dependencies
        run: pip install -e.

      - name: Build with Nuitka
        env: 
          LD_LIBRARY_PATH: /opt/homebrew/opt/portaudio/lib
        run: ${{ matrix.build-command }}

      - name: Check Nuitka build
        if: ${{ github.event.inputs.test-mode != 'true' }}
        run: |
          ls -l ${{ matrix.server-executable }}
      - name: Move skellycam exe to build into `skellycam-ui` directory
        run: |          
          mv ${{ matrix.server-executable }} skellycam-ui

      - name: Install UI dependencies
        run: |
          cd skellycam-ui
          npm install

      - name: Build UI
        run: |
          cd skellycam-ui
          npm run build

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: skellycam-${{ runner.os }}
          path: |
            ${{ matrix.electron-output }}
            build/*.dist/**
          include-hidden-files: true